<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
  <meta charset="utf-8">
  <title>CoreData 学习笔记 - Lmt的博客</title>
  <meta name="author" content="limengtian">

  
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://engili.github.io/blog/2017/08/20/coredata-note/">
  <link href="/favicon.png" type="image/png" rel="icon">
  <link href="/atom.xml" rel="alternate" title="Lmt的博客" type="application/atom+xml">

  <!-- http://opengraphprotocol.org/ -->
  <meta name="twitter:card" content="summary_large_image">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://engili.github.io/blog/2017/08/20/coredata-note/">
  <meta property="og:title" content="CoreData 学习笔记 - Lmt的博客">
  

  <script src="/javascripts/libs/jquery/jquery-2.1.3.min.js"></script>

<link href="/assets/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="/assets/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css">

<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">


  
  <link href="/stylesheets/screen.css" media="screen, projection, print" rel="stylesheet" type="text/css">

  

</head>

  <body   >
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="wrap">
      
        <header role="banner">
          <nav class="navbar navbar-default" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" title="toggle navbar" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Lmt的博客</a>
        </div>

        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <!-- <li ><a href="#">Projects</a></li> -->
<li ><a href="/blog/archives">归档</a></li>
<li ><a href="/about">关于</a></li> 
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a class="subscribe-rss" href="/atom.xml" title="subscribe via RSS">
                        <span class="visible-xs">RSS</span>
                        <img class="hidden-xs" src="/images/rss.png" alt="RSS">
                    </a>
                </li>
                
            </ul>
            
                <form class="navbar-form navbar-right" action="https://www.google.com/search" method="GET">
                    <input type="hidden" name="sitesearch" value="engili.github.io">
                    <div class="form-group">
                        <input class="form-control" type="text" name="q" placeholder="Search">
                    </div>
                </form>
            
        </div>
    </div>
</nav>


        </header>
      
      <div id="main" role="main" class="container">
        <div id="content">
          <div class="row">
  <div class="page-content" itemscope itemtype="http://schema.org/Blog">
    <meta itemprop="name" content="Lmt的博客" />
    
    <meta itemprop="url" content="http://engili.github.io" />
    <article class="hentry" role="article" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
      
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2017-08-20T18:41:45+08:00"  data-updated="true" itemprop="datePublished dateCreated">Sun 20 Aug 2017,  6:41 PM</time>
        
      </p>
    
    
    <h1 class="entry-title" itemprop="name headline">
        CoreData 学习笔记
        
    </h1>
    
  </header>


<div class="entry-content clearfix" itemprop="articleBody description"><!--more-->


<h2>1. Core Data Stack</h2>

<h3>iOS 10 以前创建CoreDataStack</h3>

<hr />

<h4>1 Data Model</h4>

<p>Data Model 是Xcode提供的一个可视化Model 编辑器，可以创建实例，定义实例属性，定义实例之间的关系，以及创建一些常用的FetchRequst</p>

<h5>1.1 新建DataModel 文件</h5>

<p><img src="https://github.com/engili/engili.github.io/raw/master/images/coredata-notes-01.png" width="547"></p>

<h5>1.2 添加实例&amp;定义属性</h5>

<p><img src="https://github.com/engili/engili.github.io/raw/master/images/coredata-notes-02.png" width="547"></p>

<h6>1.21 属性类型（Attribute Type）</h6>

<ul>
<li>Integer16 Integer32 Integer64</li>
<li>Decimal Float Double</li>
<li>String</li>
<li>Boolean</li>
<li>Date</li>
<li>Binary Data</li>
<li>Transformable</li>
</ul>


<p>其中，<code>Binary Data</code> 为二进制数据，在Xcode右侧Model Inspector 中，有一个可以设置<code>Allows External Storage</code>的选项，CoreData会智能选择是存储文件的二进制数据，还是存储文件URL</p>

<p><code>Transformable</code> 可以为任意遵循<code>NSCoding</code>协议的对象类型</p>

<h5>1.3 添加关系（relationShip）</h5>

<ul>
<li>to one （一对一）</li>
<li>to Manay （一对多）</li>
</ul>


<p>这里再定义一个实例，主人（master），设定主人和狗子的关系为一对多，关系图如下：</p>

<p><img src="https://github.com/engili/engili.github.io/raw/master/images/coredata-notes-03.png" width="547"></p>

<h4>2 CoreDataStack</h4>

<p>CoreDataStck，是自定义的一个CoreData 的栈对象，为一个单例，可以通过它，初始化项目的CoreData，以及获取到Context，对数据库进行增删改查等操作</p>

<h5>2.1 单例</h5>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='obj-c'><span class='line'><span class="c1">//  CoreDataStack.h</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#import &lt;Foundation/Foundation.h&gt;</span>
</span><span class='line'><span class="cp">#import &lt;CoreData/CoreData.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="nc">CoreDataStack</span> : <span class="bp">NSObject</span>
</span><span class='line'>
</span><span class='line'><span class="p">+</span> <span class="p">(</span><span class="kt">instancetype</span><span class="p">)</span><span class="nf">sharedInstance</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='obj-c'><span class='line'><span class="c1">//  CoreDataStack.m</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#import &quot;CoreDataStack.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@implementation</span> <span class="nc">CoreDataStack</span>
</span><span class='line'>
</span><span class='line'><span class="p">+</span> <span class="p">(</span><span class="kt">instancetype</span><span class="p">)</span><span class="nf">sharedInstance</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">static</span> <span class="n">CoreDataStack</span> <span class="o">*</span><span class="n">stack</span><span class="p">;</span>
</span><span class='line'>    <span class="k">static</span> <span class="kt">dispatch_once_t</span> <span class="n">onceToken</span><span class="p">;</span>
</span><span class='line'>    <span class="n">dispatch_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onceToken</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>        <span class="n">stack</span> <span class="o">=</span> <span class="p">[[</span><span class="n">CoreDataStack</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">stack</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<h4>3 NSManagedModel</h4>

<blockquote><p>The NSManagedObjectModel represents each object type in your app&rsquo;s data model, the properties they can have, and the relationship between them.</p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='obj-c'><span class='line'><span class="c1">//  CoreDataStack.m</span>
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="nc">CoreDataStack</span> <span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">)</span> <span class="bp">NSManagedObjectModel</span> <span class="o">*</span><span class="n">managedModel</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="p">......</span>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="bp">NSManagedObjectModel</span> <span class="o">*</span><span class="p">)</span><span class="n">managedModel</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_managedModel</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="bp">NSURL</span> <span class="o">*</span><span class="n">momdURL</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">NSBundle</span> <span class="n">mainBundle</span><span class="p">]</span><span class="nl">URLForResource</span><span class="p">:</span><span class="s">@&quot;Model&quot;</span> <span class="nl">withExtension</span><span class="p">:</span><span class="s">@&quot;momd&quot;</span><span class="p">];</span>
</span><span class='line'>        <span class="n">_managedModel</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">NSManagedObjectModel</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithContentsOfURL</span><span class="p">:</span><span class="n">momdURL</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">_managedModel</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>NSManagedObjectModel</code>通过Xcode创建的<code>DataModel</code>文件初始化，DataModel文件编译后的后缀为<code>momd</code>。</p>

<h4>4 NSPersistentStoreCoordinator</h4>

<h5>4.1 NSpersistentStore</h5>

<h6>atomic vs nonatomic</h6>

<blockquote><p>An atomic persistent store needs to be completely deserialized and loaded into memory before you can make any read or write operations. In contrast, a non- atomic persistent store can load chunks of itself onto memory as needed.</p></blockquote>

<h6>type</h6>

<ul>
<li>NSSQLiteStoreType (nonatomic)</li>
<li>NSXMLStoreType (atomic)</li>
<li>NSBinaryStoreType (atomic)</li>
<li>NSInMemoryStoreType (atomic)</li>
</ul>


<h4>4.2 NSPersistentStoreCoordinator</h4>

<blockquote><p>the bridge between the managed object model and the persistent store</p></blockquote>

<ul>
<li>通过<code>managed object model</code>初始化</li>
<li>通过<code>addPersistentStoreWithType:configuration:URL:options:error:</code> 添加<code>persistent store</code></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='obj-c'><span class='line'><span class="c1">//  CoreDataStack.m</span>
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="nc">CoreDataStack</span> <span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">)</span> <span class="bp">NSPersistentStoreCoordinator</span> <span class="o">*</span><span class="n">psc</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="p">......</span>
</span><span class='line'>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="bp">NSPersistentStoreCoordinator</span> <span class="o">*</span><span class="p">)</span><span class="n">psc</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_psc</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">_psc</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">NSPersistentStoreCoordinator</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithManagedObjectModel</span><span class="p">:</span><span class="nb">self</span><span class="p">.</span><span class="n">managedModel</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>        <span class="bp">NSURL</span> <span class="o">*</span><span class="n">URL</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">self</span> <span class="n">documentURL</span><span class="p">]</span> <span class="nl">URLByAppendingPathComponent</span><span class="p">:</span><span class="s">@&quot;Model.sqlite&quot;</span><span class="p">];</span>
</span><span class='line'>        <span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="n">_psc</span> <span class="nl">addPersistentStoreWithType</span><span class="p">:</span><span class="n">NSSQLiteStoreType</span> <span class="nl">configuration</span><span class="p">:</span><span class="nb">nil</span> <span class="nl">URL</span><span class="p">:</span><span class="n">URL</span> <span class="nl">options</span><span class="p">:</span><span class="nb">nil</span> <span class="nl">error</span><span class="p">:</span><span class="o">&amp;</span><span class="n">error</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;addPersistentStoreWithType Error: %@&quot;</span><span class="p">,[</span><span class="n">error</span> <span class="n">localizedDescription</span><span class="p">]);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">_psc</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="bp">NSURL</span> <span class="o">*</span><span class="p">)</span><span class="n">documentURL</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[[[</span><span class="bp">NSFileManager</span> <span class="n">defaultManager</span><span class="p">]</span> <span class="nl">URLsForDirectory</span><span class="p">:</span><span class="n">NSDocumentDirectory</span> <span class="nl">inDomains</span><span class="p">:</span><span class="n">NSUserDomainMask</span><span class="p">]</span> <span class="n">firstObject</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>5 NSManagedObjectContext</h4>

<p>Context是唯一暴露给外界，供外界使用的接口</p>

<blockquote><ul>
<li>context an in-memory scratchpad for managed objects.</li>
<li>any change you make won&rsquo;t affect the underlying data on disk until you call <code>-save:</code> of context</li>
<li>context manages the lifecycle of the objects that it creates or fetches.</li>
<li>A managed object cannot exist without an associated context.</li>
<li>once a managed object has associated with a particular context, it will remain associated with the same context for the duration of its lifecycle.</li>
<li>context and managed object is not thread safe</li>
</ul>
</blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='obj-c'><span class='line'><span class="c1">//  CoreDataStack.h</span>
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="nc">CoreDataStack</span> : <span class="bp">NSObject</span>
</span><span class='line'>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="bp">NSManagedObjectContext</span> <span class="o">*</span><span class="n">managedContext</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='obj-c'><span class='line'><span class="c1">//  CoreDataStack.m</span>
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="nc">CoreDataStack</span> <span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">,</span> <span class="k">readwrite</span><span class="p">)</span> <span class="bp">NSManagedObjectContext</span> <span class="o">*</span><span class="n">managedContext</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="bp">NSManagedObjectContext</span> <span class="o">*</span><span class="p">)</span><span class="n">managedContext</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_managedContext</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">_managedContext</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">NSManagedObjectContext</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithConcurrencyType</span><span class="p">:</span><span class="n">NSMainQueueConcurrencyType</span><span class="p">];</span>
</span><span class='line'>        <span class="n">_managedContext</span><span class="p">.</span><span class="n">persistentStoreCoordinator</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="n">psc</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">_managedContext</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>6 Save Context</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='obj-c'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">saveContext</span> <span class="p">{</span>
</span><span class='line'>    <span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">([</span><span class="nb">self</span><span class="p">.</span><span class="n">managedContext</span> <span class="n">hasChanges</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">managedContext</span> <span class="nl">save</span><span class="p">:</span><span class="o">&amp;</span><span class="n">error</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;NSManagedObjectContext Save Error: %@&quot;</span><span class="p">,[</span><span class="n">error</span> <span class="n">localizedDescription</span><span class="p">]);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>iOS 10 以后创建CoreDataStack</h3>

<hr />

<p>iOS 10 以后，苹果系统为我们封装了一个CoreData Stack 的类，叫<code>NSPersistentContainer</code>,可以通过它的属性<code>viewContext</code>获取到<code>NSManagedObjectContext</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='obj-c'><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="k">readonly</span><span class="p">,</span> <span class="k">strong</span><span class="p">)</span> <span class="n">NSPersistentContainer</span> <span class="o">*</span><span class="n">persistentContainer</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="n">NSPersistentContainer</span> <span class="o">*</span><span class="p">)</span><span class="nf">persistentContainer</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// The persistent container for the application. This implementation creates and returns a container, having loaded the store for the application to it.</span>
</span><span class='line'>    <span class="k">@synchronized</span> <span class="p">(</span><span class="nb">self</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">_persistentContainer</span> <span class="o">==</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">_persistentContainer</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSPersistentContainer</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithName</span><span class="p">:</span><span class="s">@&quot;testCoreData&quot;</span><span class="p">];</span>
</span><span class='line'>            <span class="p">[</span><span class="n">_persistentContainer</span> <span class="nl">loadPersistentStoresWithCompletionHandler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">NSPersistentStoreDescription</span> <span class="o">*</span><span class="n">storeDescription</span><span class="p">,</span> <span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="c1">// Replace this implementation with code to handle the error appropriately.</span>
</span><span class='line'>                    <span class="c1">// abort() causes the application to generate a crash log and terminate. You should not use this function in a shipping application, although it may be useful during development.</span>
</span><span class='line'>
</span><span class='line'>                    <span class="cm">/*</span>
</span><span class='line'><span class="cm">                     Typical reasons for an error here include:</span>
</span><span class='line'><span class="cm">                     * The parent directory does not exist, cannot be created, or disallows writing.</span>
</span><span class='line'><span class="cm">                     * The persistent store is not accessible, due to permissions or data protection when the device is locked.</span>
</span><span class='line'><span class="cm">                     * The device is out of space.</span>
</span><span class='line'><span class="cm">                     * The store could not be migrated to the current model version.</span>
</span><span class='line'><span class="cm">                     Check the error message to determine what the actual problem was.</span>
</span><span class='line'><span class="cm">                    */</span>
</span><span class='line'>                    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Unresolved error %@, %@&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="n">userInfo</span><span class="p">);</span>
</span><span class='line'>                    <span class="n">abort</span><span class="p">();</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}];</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">_persistentContainer</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">saveContext</span> <span class="p">{</span>
</span><span class='line'>    <span class="bp">NSManagedObjectContext</span> <span class="o">*</span><span class="n">context</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="n">persistentContainer</span><span class="p">.</span><span class="n">viewContext</span><span class="p">;</span>
</span><span class='line'>    <span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">([</span><span class="n">context</span> <span class="n">hasChanges</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">[</span><span class="n">context</span> <span class="nl">save</span><span class="p">:</span><span class="o">&amp;</span><span class="n">error</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Replace this implementation with code to handle the error appropriately.</span>
</span><span class='line'>        <span class="c1">// abort() causes the application to generate a crash log and terminate. You should not use this function in a shipping application, although it may be useful during development.</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Unresolved error %@, %@&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="n">userInfo</span><span class="p">);</span>
</span><span class='line'>        <span class="n">abort</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>2. 创建NSManagedObject对象</h2>

<p>可视化Data Model文件在程序中，对应了<code>NSManagedModel</code>对象，这些<code>Entity</code>在程序中，所对应的对象就是<code>NSManagedObject</code> (当然其实并不完全对等，可以先这么理解)</p>

<h3>Document</h3>

<blockquote><p>NSManagedObject is a generic class that implements all the basic behavior required of a Core Data model object. It is not possible to use instances of direct subclasses of NSObject (or any other class not inheriting from NSManagedObject) with a managed object context. You may create custom subclasses of NSManagedObject, although this is not always required. If no custom logic is needed, a complete Object graph can be formed with NSManagedObject instances.</p></blockquote>

<p>这里大概有三个要点</p>

<ul>
<li>NSManagedObject 代表了Data Model中的对象</li>
<li>NSManagedObject 需要和 NSManagedObjectContext 结合使用才有意义</li>
<li>NSManagedObject 满足所有你自定义的model 对象需求，通过KVC 去访问相应的属性</li>
</ul>


<h3>生成NSManagedObject子类</h3>

<p>虽然通过KVC就可以访问NSManagedObject所有的属性，但这样使用起来不是很方便。</p>

<p>在Xcode Data Model Editor 中选中你要创建NSManagedObject子类的实例，在右侧<code>Data Model Inspector</code>中选择<code>Codegen</code></p>

<p><img src="https://github.com/engili/engili.github.io/raw/master/images/coredata-notes-04.png" width="547"></p>

<ul>
<li>Manual/None</li>
<li>Category/Extension.</li>
<li>Class Definition</li>
</ul>


<blockquote><p>Manual/None is the default, and previous behavior; in this case you should implement your own subclass or use NSManagedObject.</p></blockquote>

<p>这个是iOS10以前的默认行为，需要我们手动通过Xcode <code>Editor-&gt; Create NSManagedObject SubClass...</code> 生成<code>ClassName+CoreDataClass</code> 文件以及 <code>ClassName+CoreDataGeneratedProperties</code> 其中前者，是类的定义，以及类行为定义，后者通过category 定义了类的属性（注：Objective-C中Category定义属性不支持生成成员变量，但可以生成get set 方法，CoreData属性通过@dynamic修饰，表示，运行时生成 get set 方法）</p>

<p>当每次修改，data model的时候，重新通过以上方法，生成NSManagedObject对象，系统只会覆盖<code>ClassName+CoreDataGeneratedProperties</code>文件，而不会修改<code>ClassName+CoreDataClass</code> 文件。</p>

<blockquote><p>Category/Extension generates a class extension in a file named like ClassName+CoreDataGeneratedProperties. You need to declare/implement the main class (if in Obj-C, via a header the extension can import named ClassName.h).</p></blockquote>

<p>一般情况下，因为我们不需要修改属性Category的定义，而只需要修改类行为的定义，所以这个选项，就直接不对开发者暴露Category 文件，当你修改了DataModel的时候，就可以自动同步最新的代码</p>

<blockquote><p>Class Definition generates subclass files named like ClassName+CoreDataClass as well as the files generated for Category/Extension.</p></blockquote>

<p>当我们也不需要为<code>NSManagedObject</code>定义行为的时候，我们就可以选中这个选项，然后直接在项目里引用头文件就可以直接使用。</p>

<h3>数据库 增删改查</h3>

<h4>增</h4>

<p>增加一个数据库对象，首先，需要创建一个<code>NSEntityDescription</code>,前面说 Data Model Editor 里的实例并不完全和<code>NSManagedObject</code>对等，就是因为创建<code>NSManagedObject</code>对象，还需要entity相关的描述对象，这个对象才与实例对等。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='obj-c'><span class='line'><span class="bp">NSEntityDescription</span> <span class="o">*</span><span class="n">entity</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSEntityDescription</span> <span class="nl">entityForName</span><span class="p">:</span><span class="s">@&quot;Doge&quot;</span> <span class="nl">inManagedObjectContext</span><span class="p">:</span><span class="n">_context</span><span class="p">];</span>
</span><span class='line'><span class="n">Doge</span> <span class="o">*</span><span class="n">doge</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Doge</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithEntity</span><span class="p">:</span><span class="n">entity</span> <span class="nl">insertIntoManagedObjectContext</span><span class="p">:</span><span class="n">_context</span><span class="p">];</span>
</span><span class='line'><span class="n">doge</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">@&quot;xxx&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="c1">//注意，这里并没有实际把对象存入数据库，实际存入需要调用NSManagedObjectContext 的save:方法</span>
</span><span class='line'><span class="p">[</span><span class="n">_context</span> <span class="nl">save</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<h4>改</h4>

<p>直接访问<code>NSManagedObject</code>属性的set方法，就可以修改属性，同时，也只有当调用了NSManagedObjectContext 的<code>-save:</code>方法后才能存入实际的存储文件中</p>

<h4>删</h4>

<p>删除调用<code>NSManagedObjectContext</code>的<code>-deleteObject:</code>方法，然后调用<code>-save:</code>方法</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='obj-c'><span class='line'> <span class="n">Doge</span> <span class="o">*</span><span class="n">doge</span> <span class="o">=</span> <span class="p">...</span>
</span><span class='line'> <span class="p">[</span><span class="n">_context</span> <span class="nl">deleteObject</span><span class="p">:</span><span class="n">doge</span><span class="p">];</span>
</span><span class='line'> <span class="p">[</span><span class="n">_context</span> <span class="nl">save</span><span class="p">:</span><span class="nb">nil</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<h4>查</h4>

<h5>1. NSFetchRequest</h5>

<h6>resultType</h6>

<ul>
<li>NSManagedObjectResultType</li>
<li>NSCountResultType</li>
<li>NSDictionaryResultType</li>
<li>NSManagedObjectIDResultType</li>
</ul>


<p>其中默认属性为<code>NSManagedObjectResultType</code></p>

<h6>NSManagedObjectResultType</h6>

<p><code>NSManagedObjectResultType</code>是NSFetchRequest 的默认属性，执行查询后，数组里每个元素，就是NSFetchRequest 对应的NSManagedObject对象。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='obj-c'><span class='line'><span class="bp">NSFetchRequest</span> <span class="o">*</span><span class="n">fetchRequest</span> <span class="o">=</span>  <span class="p">[</span><span class="bp">NSFetchRequest</span> <span class="nl">fetchRequestWithEntityName</span><span class="p">:</span><span class="s">@&quot;Doge&quot;</span><span class="p">];</span>
</span><span class='line'><span class="c1">//默认就为NSManagedObjectResultType</span>
</span><span class='line'><span class="c1">//fetchRequest.resultType = NSManagedObjectResultType;</span>
</span><span class='line'><span class="bp">NSArray</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">_context</span> <span class="nl">executeFetchRequest</span><span class="p">:</span><span class="n">fetchRequest</span> <span class="nl">error</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'><span class="c1">//这里数组的元素为Doge对象</span>
</span></code></pre></td></tr></table></div></figure>


<h6>NSCountResultType</h6>

<p><code>NSCountResultType</code>执行查询后，返回的数组，包含一个对象，NSNmber.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='obj-c'><span class='line'><span class="bp">NSFetchRequest</span> <span class="o">*</span><span class="n">fetchRequest</span> <span class="o">=</span>  <span class="p">[</span><span class="bp">NSFetchRequest</span> <span class="nl">fetchRequestWithEntityName</span><span class="p">:</span><span class="s">@&quot;Doge&quot;</span><span class="p">];</span>
</span><span class='line'><span class="n">fetchRequest</span><span class="p">.</span><span class="n">resultType</span> <span class="o">=</span> <span class="n">NSCountResultType</span><span class="p">;</span>
</span><span class='line'><span class="bp">NSArray</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">_context</span> <span class="nl">executeFetchRequest</span><span class="p">:</span><span class="n">fetchRequest</span> <span class="nl">error</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'><span class="c1">//这里数组的元素为 NSNumber ，一般数组只有一个元素</span>
</span><span class='line'><span class="k">if</span> <span class="p">([</span><span class="n">result</span> <span class="n">count</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
</span><span class='line'>    <span class="bp">NSInteger</span> <span class="n">count</span> <span class="o">=</span> <span class="p">[[</span><span class="n">results</span> <span class="nl">objectAtIndex</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span> <span class="n">integerValue</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h6>NSDictionaryResultType</h6>

<p><code>NSDictionaryResultType</code> 顾名思义，是返回一个字典，除了设置<code>fetchRequest.resultType</code>,还需要设置<code>fetchRequest.propertiesToFetch</code></p>

<h6>NSManagedObjectIDResultType</h6>

<p>返回唯一标识</p>

<blockquote><p>Prior to iOS 5, fetching by ID was popular because NSManagedObjectID is thread-safe and using it helped developers implement the thread confinement concurrency model. Now that thread confinement has been deprecated in favor of more modern concurrency models, there’s little reason to fetch by object ID anymore.</p></blockquote>

<h5>2. NSPredicate</h5>

<blockquote><p>The NSPredicate class is used to define logical conditions used to constrain a search either for a fetch or for in-memory filtering.</p></blockquote>

<p>NSFetchRequest 支持使用谓词来作为，查询筛选条件</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='obj-c'><span class='line'><span class="bp">NSFetchRequest</span> <span class="o">*</span><span class="n">fetchRequest</span> <span class="o">=</span>  <span class="p">[</span><span class="bp">NSFetchRequest</span> <span class="nl">fetchRequestWithEntityName</span><span class="p">:</span><span class="s">@&quot;Doge&quot;</span><span class="p">];</span>
</span><span class='line'><span class="nl">fetchRequestWithEntityName</span><span class="p">:</span><span class="s">@&quot;Doge&quot;</span><span class="p">];</span>
</span><span class='line'><span class="n">fetchRequest</span><span class="p">.</span><span class="n">predicate</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSPredicate</span> <span class="nl">predicateWithFormat</span><span class="p">:</span><span class="s">@&quot;age &gt; 5&quot;</span><span class="p">];</span>
</span><span class='line'><span class="bp">NSArray</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">_context</span> <span class="nl">executeFetchRequest</span><span class="p">:</span><span class="n">fetchRequest</span> <span class="nl">error</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<h5>3. NSSortDescriptor</h5>

<p>除了使用支持使用谓词，NSFetchRequest 还支持使用<code>NSSortDescriptor</code> 进行排序</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='obj-c'><span class='line'>   <span class="bp">NSFetchRequest</span> <span class="o">*</span><span class="n">fetchRequest</span> <span class="o">=</span>  <span class="p">[</span><span class="bp">NSFetchRequest</span> <span class="nl">fetchRequestWithEntityName</span><span class="p">:</span><span class="s">@&quot;Doge&quot;</span><span class="p">];</span>
</span><span class='line'>    <span class="bp">NSSortDescriptor</span> <span class="o">*</span><span class="n">sortDescriptor</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSSortDescriptor</span> <span class="nl">sortDescriptorWithKey</span><span class="p">:</span><span class="s">@&quot;age&quot;</span> <span class="nl">ascending</span><span class="p">:</span><span class="nb">YES</span><span class="p">];</span>
</span><span class='line'>    <span class="n">fetchRequest</span><span class="p">.</span><span class="n">sortDescriptors</span> <span class="o">=</span> <span class="l">@[</span><span class="n">sortDescriptor</span><span class="l">]</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="bp">NSArray</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">_context</span> <span class="nl">executeFetchRequest</span><span class="p">:</span><span class="n">fetchRequest</span> <span class="nl">error</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<h5>4. NSAsynchronousFetchRequest</h5>

<p>NSFetchRequest 是同步查询的，CoreData 也提供了异步查询的类<code>NSAsynchronousFetchRequest</code>,它通过一个 block ，将数据异步返回，注意，查询方法使用的是 <code>-executeRequest:error:</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='obj-c'><span class='line'><span class="bp">NSFetchRequest</span> <span class="o">*</span><span class="n">fetchRequest</span> <span class="o">=</span>  <span class="p">[</span><span class="bp">NSFetchRequest</span> <span class="nl">fetchRequestWithEntityName</span><span class="p">:</span><span class="s">@&quot;Doge&quot;</span><span class="p">];</span>
</span><span class='line'><span class="n">NSAsynchronousFetchRequest</span> <span class="o">*</span><span class="n">asyncFetchRequest</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSAsynchronousFetchRequest</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithFetchRequest</span><span class="p">:</span><span class="n">fetchRequest</span> <span class="nl">completionBlock</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">NSAsynchronousFetchResult</span> <span class="o">*</span> <span class="n">_Nonnull</span> <span class="n">results</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span><span class="n">results</span><span class="p">);</span>
</span><span class='line'><span class="p">}];</span>
</span><span class='line'><span class="p">[</span><span class="n">_context</span> <span class="nl">executeRequest</span><span class="p">:</span><span class="n">asyncFetchRequest</span> <span class="nl">error</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Demo</h3>

<h4>添加数据</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
</pre></td><td class='code'><pre><code class='obj-c'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">application:</span><span class="p">(</span><span class="bp">UIApplication</span> <span class="o">*</span><span class="p">)</span><span class="nv">application</span> <span class="nf">didFinishLaunchingWithOptions:</span><span class="p">(</span><span class="bp">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">launchOptions</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Override point for customization after application launch.</span>
</span><span class='line'>    <span class="p">[</span><span class="nb">self</span> <span class="n">importSeedJsonSeedIfNeeded</span><span class="p">];</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">YES</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">importSeedJsonSeedIfNeeded</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="bp">NSManagedObjectContext</span> <span class="o">*</span><span class="n">context</span> <span class="o">=</span> <span class="p">[[</span><span class="n">MTCoreDataStack</span> <span class="n">sharedInstance</span><span class="p">]</span> <span class="n">managedContext</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="bp">NSFetchRequest</span> <span class="o">*</span> <span class="n">fetchRequest</span> <span class="o">=</span> <span class="p">[</span><span class="n">Master</span> <span class="n">fetchRequest</span><span class="p">];</span>
</span><span class='line'>    <span class="n">fetchRequest</span><span class="p">.</span><span class="n">resultType</span> <span class="o">=</span> <span class="n">NSCountResultType</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">;</span>
</span><span class='line'>    <span class="bp">NSArray</span> <span class="o">*</span><span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">context</span> <span class="nl">executeFetchRequest</span><span class="p">:</span><span class="n">fetchRequest</span> <span class="nl">error</span><span class="p">:</span><span class="o">&amp;</span><span class="n">error</span><span class="p">];</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">([</span><span class="n">results</span> <span class="n">count</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="bp">NSInteger</span> <span class="n">masterCount</span> <span class="o">=</span> <span class="p">[[</span><span class="n">results</span> <span class="nl">objectAtIndex</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span> <span class="n">integerValue</span><span class="p">];</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">masterCount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="p">[</span><span class="nb">self</span> <span class="n">importJsonSeed</span><span class="p">];</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="p">[</span><span class="nb">self</span> <span class="n">importJsonSeed</span><span class="p">];</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">[</span><span class="nb">self</span> <span class="n">importJsonSeed</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">importJsonSeed</span> <span class="p">{</span>
</span><span class='line'>    <span class="bp">NSURL</span> <span class="o">*</span><span class="n">jsonURL</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">NSBundle</span> <span class="n">mainBundle</span><span class="p">]</span> <span class="nl">URLForResource</span><span class="p">:</span><span class="s">@&quot;seed&quot;</span> <span class="nl">withExtension</span><span class="p">:</span><span class="s">@&quot;json&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">;</span>
</span><span class='line'>    <span class="bp">NSData</span> <span class="o">*</span><span class="n">jsonData</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSData</span> <span class="nl">dataWithContentsOfURL</span><span class="p">:</span><span class="n">jsonURL</span> <span class="nl">options</span><span class="p">:</span><span class="mi">0</span> <span class="nl">error</span><span class="p">:</span><span class="o">&amp;</span><span class="n">error</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="bp">NSDictionary</span> <span class="o">*</span><span class="n">jsonDict</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSJSONSerialization</span> <span class="nl">JSONObjectWithData</span><span class="p">:</span><span class="n">jsonData</span> <span class="nl">options</span><span class="p">:</span><span class="mi">0</span> <span class="nl">error</span><span class="p">:</span><span class="o">&amp;</span><span class="n">error</span><span class="p">];</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>            <span class="bp">NSManagedObjectContext</span> <span class="o">*</span><span class="n">context</span> <span class="o">=</span> <span class="p">[[</span><span class="n">MTCoreDataStack</span> <span class="n">sharedInstance</span><span class="p">]</span> <span class="n">managedContext</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>            <span class="bp">NSEntityDescription</span> <span class="o">*</span><span class="n">masterEntity</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSEntityDescription</span> <span class="nl">entityForName</span><span class="p">:</span><span class="s">@&quot;Master&quot;</span> <span class="nl">inManagedObjectContext</span><span class="p">:</span><span class="n">context</span><span class="p">];</span>
</span><span class='line'>            <span class="bp">NSEntityDescription</span> <span class="o">*</span><span class="n">dogeEntity</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSEntityDescription</span> <span class="nl">entityForName</span><span class="p">:</span><span class="s">@&quot;Doge&quot;</span> <span class="nl">inManagedObjectContext</span><span class="p">:</span><span class="n">context</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>            <span class="bp">NSDictionary</span> <span class="o">*</span><span class="n">masterDict</span> <span class="o">=</span> <span class="n">jsonDict</span><span class="p">[</span><span class="s">@&quot;master&quot;</span><span class="p">];</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="n">masterDict</span> <span class="nl">isKindOfClass</span><span class="p">:[</span><span class="bp">NSDictionary</span> <span class="k">class</span><span class="p">]])</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">return</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">Master</span> <span class="o">*</span><span class="n">master</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Master</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithEntity</span><span class="p">:</span><span class="n">masterEntity</span> <span class="nl">insertIntoManagedObjectContext</span><span class="p">:</span><span class="n">context</span><span class="p">];</span>
</span><span class='line'>            <span class="n">master</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">masterDict</span><span class="p">[</span><span class="s">@&quot;name&quot;</span><span class="p">];</span>
</span><span class='line'>            <span class="n">master</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="p">[</span><span class="n">masterDict</span><span class="p">[</span><span class="s">@&quot;age&quot;</span><span class="p">]</span> <span class="n">integerValue</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>            <span class="bp">NSArray</span> <span class="o">*</span><span class="n">doges</span> <span class="o">=</span> <span class="n">jsonDict</span><span class="p">[</span><span class="s">@&quot;doges&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">for</span> <span class="p">(</span><span class="bp">NSDictionary</span> <span class="o">*</span><span class="n">dogeDict</span> <span class="k">in</span> <span class="n">doges</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="n">dogeDict</span> <span class="nl">isKindOfClass</span><span class="p">:[</span><span class="bp">NSDictionary</span> <span class="k">class</span><span class="p">]])</span> <span class="p">{</span>
</span><span class='line'>                    <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="n">Doge</span> <span class="o">*</span><span class="n">doge</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Doge</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithEntity</span><span class="p">:</span><span class="n">dogeEntity</span> <span class="nl">insertIntoManagedObjectContext</span><span class="p">:</span><span class="n">context</span><span class="p">];</span>
</span><span class='line'>                <span class="n">doge</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">dogeDict</span><span class="p">[</span><span class="s">@&quot;name&quot;</span><span class="p">];</span>
</span><span class='line'>                <span class="n">doge</span><span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="p">[</span><span class="n">dogeDict</span><span class="p">[</span><span class="s">@&quot;age&quot;</span><span class="p">]</span> <span class="n">integerValue</span><span class="p">];</span>
</span><span class='line'>                <span class="n">doge</span><span class="p">.</span><span class="n">master</span> <span class="o">=</span> <span class="n">master</span><span class="p">;</span> <span class="c1">//因为在DataModel 里设置了 inverse， 所以master 和 doge可以相互关联上</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="c1">//一定要调用 save 方法，才能真正的将文件存入数据库</span>
</span><span class='line'>            <span class="p">[[</span><span class="n">MTCoreDataStack</span> <span class="n">sharedInstance</span><span class="p">]</span> <span class="n">saveContext</span><span class="p">];</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>



</div>


      <footer class="post-footer">
        <p class="meta text-muted">
          
  



<figure class="author-image">
    <span class="img" href="/about" style="background-image: url(/images/avatar.jpg)"><span class="hidden">Picture</span></span>
</figure>

<section class="author">
    <h4><span class="byline author vcard" itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="fn" itemprop="name">limengtian</span></span></h4>

    <div class="author-meta">
        <span class="author-link icon-link"><i class="fa fa-link" aria-hidden="true"></i> <a href="http://engili.github.io">http://engili.github.io</a></span>
    </div>
</section>

<hr>

<section class="share">
    
    <h4>Share this post</h4>
    
    <a class="fa fa-twitter" href="https://twitter.com/intent/tweet?url=http://engili.github.io/blog/2017/08/20/coredata-note/;" 
        onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="fa fa-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://engili.github.io/blog/2017/08/20/coredata-note/" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
    </a>
    <a class="fa fa-google-plus" href="https://plus.google.com/share?url=http://engili.github.io/blog/2017/08/20/coredata-note/" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
    </a>
    
</section>




<!--
<footer class="post-footer">


            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="https://twitter.com/intent/tweet?text=Instant%20Movie%20Streamer%20v3%20Release&amp;url=http://iyask.me/instant-movie-streamer-v3-release/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://iyask.me/instant-movie-streamer-v3-release/" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=http://iyask.me/instant-movie-streamer-v3-release/" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>


        </footer>


-->
          












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2017-08-20T18:41:45+08:00"  data-updated="true" itemprop="datePublished dateCreated">Sun 20 Aug 2017,  6:41 PM</time>
          <br>

<span class="glyphicon glyphicon-tags"></span>&nbsp;
<span class="categories">
  
    <a class='category' href='/blog/categories/core-data/'>core data</a>, <a class='category' href='/blog/categories/ios/'>ios</a>
  
</span>


        </p>
        
          <div class="pager">
            
            
              
                <a href="/blog/2017/08/05/layoutMagrin-preservesSuperviewLayoutMargins-notes/" class="col-xs-12 col-md-4 btn btn-default" title="Previous Post: LayoutMargin & preservesSuperviewLayoutMargins 学习笔记"> 
                  <div class="text-muted">
                    <small>Previous Post</small>
                  </div>
                  <div class="pager-title">
                    <h4>LayoutMargin & preservesSuperviewLayoutMargins 学习笔记</h4>
                  </div>
                </a>
              
            
            
            
              
              <a href="/blog/2018/03/24/uikit-animations-note/" class="col-xs-12 col-md-4 btn btn-default pull-right" title="Next Post: UIKit Animations 学习笔记">
                <div class="text-muted">
                  <small>Next Post</small>
                </div>
                <div class="pager-title">
                  <h4>UIKit Animations 学习笔记</h4>
                </div>
              </a>
              
            
            
          </div>
        
      </footer>
    </article>
    
  </div>
</div>

        </div>
      </div>
    </div>
    <footer role="contentinfo"><div class="container">
    <p class="text-muted credits">
  Copyright &copy; 2018 - limengtian<br>
  <small>
      <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>,
      <span class="credit">customized with <a href="https://github.com/bhrigu123/abacus">abacus theme</a></span>.
  </small>
</p>

</div>
</footer>
    








<script src="/assets/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/javascripts/modernizr.js"></script>


  </body>
</html>
